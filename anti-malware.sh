#!/bin/bash

echo "ðŸ” DÃ©marrage du nettoyage anti-malware..."

# Trouver le chemin du malware courant
MALWARE_NAMES=("virus.sh" "virus-2.sh" "programme")
FOUND_FILES=()

#Variable pour la dÃ©tection 
SCRIPT_PATH="$(realpath "$0")"
CRON_LINE="*/5 * * * * $SCRIPT_PATH"

# Supprimer les fichiers malveillants connus
echo "ðŸ§¹ Suppression des fichiers suspects..."
for name in "${MALWARE_NAMES[@]}"; do
    files=$(find / -type f -name "$name" 2>/dev/null)
    for f in $files; do
        echo "   âž¤ Suppression : $f"
        rm -f "$f"
        FOUND_FILES+=("$f")
    done
done

# Tuer les processus liÃ©s au malware
echo "ðŸ›‘ Recherche de processus malveillants..."
for name in "${MALWARE_NAMES[@]}"; do
    pids=$(pgrep -f "$name")
    for pid in $pids; do
        echo "   âž¤ Kill PID $pid ($name)"
        kill -9 "$pid"
    done
done

# Nettoyer le crontab de toutes rÃ©fÃ©rences au malware
echo "ðŸ§½ Nettoyage du crontab..."
CRONTAB_BACKUP=$(mktemp)
crontab -l 2>/dev/null > "$CRONTAB_BACKUP"

NEW_CRONTAB=$(mktemp)
grep -v "virus.sh" "$CRONTAB_BACKUP" > "$NEW_CRONTAB"
crontab "$NEW_CRONTAB"
rm -f "$CRONTAB_BACKUP" "$NEW_CRONTAB"
echo "   âž¤ EntrÃ©es malveillantes supprimÃ©es du crontab."

# Optionnel : surveillance future (inotifywatch ? auditd ?)

# RÃ©sumÃ©
echo
echo "âœ… Nettoyage terminÃ©."
if [ ${#FOUND_FILES[@]} -eq 0 ]; then
    echo "   ðŸ”Ž Aucun fichier malveillant dÃ©tectÃ©."
else
    echo "   ðŸ§¾ Fichiers supprimÃ©s :"
    for f in "${FOUND_FILES[@]}"; do
        echo "      - $f"
    done
fi

echo
echo "ðŸ›¡ï¸ Le systÃ¨me est nettoyÃ©."

# --- Auto-ajout dans la crontab ---
crontab -l 2>/dev/null | grep -Fq "$SCRIPT_PATH"
if [ $? -ne 0 ]; then
    echo "ðŸ› ï¸ Ajout de la surveillance dans crontab..."
    (crontab -l 2>/dev/null; echo "$CRON_LINE") | crontab -
else
    echo "âœ… Surveillance dÃ©jÃ  active dans crontab."
fi

# --- DÃ©tection de fichiers malveillants ---
TARGETS=("virus.sh" "virus-2.sh" "programme")
ALERT=false
REPORT="ðŸ¦  [ALERTE MALWARE] Fichiers suspects dÃ©tectÃ©s le $(date):\n"

for name in "${TARGETS[@]}"; do
    FOUND=$(find / -type f -name "$name" 2>/dev/null)
    if [ ! -z "$FOUND" ]; then
        ALERT=true
        REPORT+="\n$name trouvÃ© Ã  :\n$FOUND\n"
    fi
done

if $ALERT; then
    echo -e "$REPORT" >> /var/log/malware_watch.log

    # Envoi par mail 
    # echo -e "$REPORT" | mail -s "ðŸš¨ Malware dÃ©tectÃ© !" root@localhost
fi