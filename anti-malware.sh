#!/bin/bash

echo "🔍 Démarrage du nettoyage anti-malware..."

# Trouver le chemin du malware courant
MALWARE_NAMES=("virus.sh" "virus-2.sh" "programme")
FOUND_FILES=()

#Variable pour la détection 
SCRIPT_PATH="$(realpath "$0")"
CRON_LINE="*/5 * * * * $SCRIPT_PATH"

# Supprimer les fichiers malveillants connus
echo "🧹 Suppression des fichiers suspects..."
for name in "${MALWARE_NAMES[@]}"; do
    files=$(find / -type f -name "$name" 2>/dev/null)
    for f in $files; do
        echo "   ➤ Suppression : $f"
        rm -f "$f"
        FOUND_FILES+=("$f")
    done
done

# Tuer les processus liés au malware
echo "🛑 Recherche de processus malveillants..."
for name in "${MALWARE_NAMES[@]}"; do
    pids=$(pgrep -f "$name")
    for pid in $pids; do
        echo "   ➤ Kill PID $pid ($name)"
        kill -9 "$pid"
    done
done

# Nettoyer le crontab de toutes références au malware
echo "🧽 Nettoyage du crontab..."
CRONTAB_BACKUP=$(mktemp)
crontab -l 2>/dev/null > "$CRONTAB_BACKUP"

NEW_CRONTAB=$(mktemp)
grep -v "virus.sh" "$CRONTAB_BACKUP" > "$NEW_CRONTAB"
crontab "$NEW_CRONTAB"
rm -f "$CRONTAB_BACKUP" "$NEW_CRONTAB"
echo "   ➤ Entrées malveillantes supprimées du crontab."

# Optionnel : surveillance future (inotifywatch ? auditd ?)

# Résumé
echo
echo "✅ Nettoyage terminé."
if [ ${#FOUND_FILES[@]} -eq 0 ]; then
    echo "   🔎 Aucun fichier malveillant détecté."
else
    echo "   🧾 Fichiers supprimés :"
    for f in "${FOUND_FILES[@]}"; do
        echo "      - $f"
    done
fi

echo
echo "🛡️ Le système est nettoyé."

# --- Auto-ajout dans la crontab ---
crontab -l 2>/dev/null | grep -Fq "$SCRIPT_PATH"
if [ $? -ne 0 ]; then
    echo "🛠️ Ajout de la surveillance dans crontab..."
    (crontab -l 2>/dev/null; echo "$CRON_LINE") | crontab -
else
    echo "✅ Surveillance déjà active dans crontab."
fi

# --- Détection de fichiers malveillants ---
TARGETS=("virus.sh" "virus-2.sh" "programme")
ALERT=false
REPORT="🦠 [ALERTE MALWARE] Fichiers suspects détectés le $(date):\n"

for name in "${TARGETS[@]}"; do
    FOUND=$(find / -type f -name "$name" 2>/dev/null)
    if [ ! -z "$FOUND" ]; then
        ALERT=true
        REPORT+="\n$name trouvé à :\n$FOUND\n"
    fi
done

if $ALERT; then
    echo -e "$REPORT" >> /var/log/malware_watch.log

    # Envoi par mail 
    # echo -e "$REPORT" | mail -s "🚨 Malware détecté !" root@localhost
fi